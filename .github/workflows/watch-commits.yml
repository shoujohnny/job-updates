name: Watch Internship Repos

permissions:
  contents: write

on:
  schedule:
    - cron: '*/5 * * * *'  # Every 5 minutes
  workflow_dispatch:

jobs:
  check-commits:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout this repo
        uses: actions/checkout@v3

      - name: Set up Git credentials for push
        run: |
          git config user.name "GitHub Action"
          git config user.email "action@github.com"
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}

      - name: Check for new commits and notify Discord
        run: |
          repos=(
            "SimplifyJobs/Summer2025-Internships"
            "vanshb03/Summer2026-Internships"
            "octocat/Hello-World"  # <-- Add more repos here
          )

          for repo in "${repos[@]}"; do
            echo "ðŸ” Checking $repo"
            latest_commit=$(curl -s https://api.github.com/repos/$repo/commits | jq -r '.[0].sha')
            commit_msg=$(curl -s https://api.github.com/repos/$repo/commits | jq -r '.[0].commit.message')
            commit_url=$(curl -s https://api.github.com/repos/$repo/commits | jq -r '.[0].html_url')
            state_file=".${repo//\//_}.txt"

            if [[ -f $state_file ]]; then
              prev_commit=$(cat $state_file)
              if [[ "$latest_commit" != "$prev_commit" ]]; then
                echo "âœ… New commit found for $repo"
                curl -H "Content-Type: application/json" -X POST \
                -d "{\"content\": \"ðŸ”” **New commit to [$repo]($commit_url)**\n\n\`\`\`\n$commit_msg\n\`\`\`\nðŸ”— $commit_url\"}" \
                ${{ secrets.DISCORD_WEBHOOK_URL }}
              fi
            else
              echo "ðŸ†• First time tracking $repo"
              echo "$latest_commit" > $state_file
              continue
            fi

            echo "$latest_commit" > $state_file
          done

      - name: Commit updated state files
        run: |
          git add .
          git commit -m "Update last known commit SHAs" || echo "No changes"
          git push
