name: Notify on New Internship Roles

permissions:
  contents: write

on:
  schedule:
    - cron: '*/10 * * * *'
  workflow_dispatch:

jobs:
  monitor-internships:
    runs-on: ubuntu-latest
    env:
      DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}

    steps:
      - name: Checkout this repo
        uses: actions/checkout@v4

      - name: Setup Git config
        run: |
          git config user.name "GitHub Action"
          git config user.email "action@github.com"
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}

      - name: Download SimplifyJobs README
        run: |
          if ! curl -sSf https://raw.githubusercontent.com/SimplifyJobs/Summer2025-Internships/dev/README.md -o simplify.md; then
            curl -sSf https://raw.githubusercontent.com/SimplifyJobs/Summer2025-Internships/main/README.md -o simplify.md
          fi

      - name: Download Vansh README
        run: |
          curl -sSf https://raw.githubusercontent.com/vanshb03/Summer2026-Internships/main/README.md -o ouckah.md

      - name: Extract Simplify SWE Roles
        run: |
          mkdir -p cache
          awk '
          BEGIN {flag=0}
          /^## [ðŸ’»ðŸ–¥ï¸ðŸ’¼].*Software Engineering/ {flag=1; next}
          /^## [ðŸ’»ðŸ–¥ï¸ðŸ’¼]/ && flag && !/Software Engineering/ {flag=0}
          /^\| / && flag {
            if ($0 ~ /^\| *Company *\| *Role *\| *Location *\|/) next
            if ($0 ~ /^\|[-| :]*\|?$/) next
            print
          }' simplify.md > cache/latest_simplify_swe.md || true

          if [ ! -s cache/latest_simplify_swe.md ]; then
            awk '
            /^\| Company \| Role \| Location/ {getline; next}
            /^\|[-| :]*\|?$/ {next}
            /^\| / {print}
            ' simplify.md > cache/latest_simplify_swe.md
          fi

      - name: Extract Vansh Roles
        run: |
          mkdir -p cache
          awk '
          /^\| Company \| Role \| Location/ {
            getline; getline
            while (getline && /^\| /) {
              if (!/ðŸ”’/ && !/---/) print
            }
          }' ouckah.md > cache/latest_ouckah.md

      - name: Diff Simplify SWE Roles
        id: simplify_diff
        run: |
          new_file="cache/latest_simplify_swe.md"
          old_file="cache/prev_simplify_swe.md"
          if [ -f "$old_file" ] && [ -s "$old_file" ]; then
            comm -23 <(sort "$new_file") <(sort "$old_file") > cache/added_simplify.md
          else
            head -3 "$new_file" > cache/added_simplify.md
          fi

          if [ -s cache/added_simplify.md ]; then
            echo "new_simplify=true" >> $GITHUB_OUTPUT
          else
            echo "new_simplify=false" >> $GITHUB_OUTPUT
          fi

      - name: Diff Vansh Roles
        id: ouckah_diff
        run: |
          new_file="cache/latest_ouckah.md"
          old_file="cache/prev_ouckah.md"
          if [ -f "$old_file" ] && [ -s "$old_file" ]; then
            comm -23 <(sort "$new_file") <(sort "$old_file") > cache/added_ouckah.md
          else
            head -3 "$new_file" > cache/added_ouckah.md
          fi

          if [ -s cache/added_ouckah.md ]; then
            echo "new_ouckah=true" >> $GITHUB_OUTPUT
          else
            echo "new_ouckah=false" >> $GITHUB_OUTPUT
          fi

      - name: Notify Discord - Simplify SWE
        if: steps.simplify_diff.outputs.new_simplify == 'true'
        run: |
          escape_md() {
            echo "$1" | sed -e 's/\\/\\\\/g' -e 's/\*/\\*/g' -e 's/_/\\_/g' -e 's/`/\\`/g' -e 's/~/\\~/g' -e 's/>/\\>/g' -e 's/|/\\|/g'
          }

          count=0
          while IFS= read -r line && [ $count -lt 5 ]; do
            [ -z "$line" ] && continue
            pipe_count=$(echo "$line" | grep -o '|' | wc -l)
            [ "$pipe_count" -lt 4 ] && continue

            company=$(escape_md "$(echo "$line" | cut -d '|' -f2 | xargs)")
            role=$(escape_md "$(echo "$line" | cut -d '|' -f3 | xargs)")
            location=$(escape_md "$(echo "$line" | cut -d '|' -f4 | xargs)")
            link=$(echo "$line" | grep -o 'https://[^ )]*' | head -1)

            msg="ðŸš¨ **New SWE Internship (SimplifyJobs)**\n\n**Company**: $company\n**Role**: $role\n**Location**: $location"
            [ -n "$link" ] && msg="$msg\n**Apply**: $link"

            curl -s -H "Content-Type: application/json" -X POST -d "{\"content\": \"$msg\"}" "$DISCORD_WEBHOOK_URL"
            count=$((count + 1))
            sleep 1
          done < cache/added_simplify.md

      - name: Notify Discord - Vansh Roles
        if: steps.ouckah_diff.outputs.new_ouckah == 'true'
        run: |
          escape_md() {
            echo "$1" | sed -e 's/\\/\\\\/g' -e 's/\*/\\*/g' -e 's/_/\\_/g' -e 's/`/\\`/g' -e 's/~/\\~/g' -e 's/>/\\>/g' -e 's/|/\\|/g'
          }

          count=0
          while IFS= read -r line && [ $count -lt 5 ]; do
            [ -z "$line" ] && continue
            pipe_count=$(echo "$line" | grep -o '|' | wc -l)
            [ "$pipe_count" -lt 4 ] && continue

            company=$(escape_md "$(echo "$line" | cut -d '|' -f2 | xargs)")
            role=$(escape_md "$(echo "$line" | cut -d '|' -f3 | xargs)")
            location=$(escape_md "$(echo "$line" | cut -d '|' -f4 | xargs)")
            link=$(echo "$line" | grep -o 'https://[^ )]*' | head -1)

            msg="ðŸ“¢ **New Internship (Vansh/Ouckah)**\n\n**Company**: $company\n**Role**: $role\n**Location**: $location"
            [ -n "$link" ] && msg="$msg\n**Apply**: $link"

            curl -s -H "Content-Type: application/json" -X POST -d "{\"content\": \"$msg\"}" "$DISCORD_WEBHOOK_URL"
            count=$((count + 1))
            sleep 1
          done < cache/added_ouckah.md

      - name: Save State Files
        run: |
          cp cache/latest_simplify_swe.md cache/prev_simplify_swe.md
          cp cache/latest_ouckah.md cache/prev_ouckah.md

      - name: Commit updated role caches
        run: |
          git add cache/prev_*.md || true
          if git diff --staged --quiet; then
            echo "âœ… No changes to commit"
          else
            git commit -m "Update internship role cache [$(date)]" || echo "âš ï¸ Commit failed"
            git push || echo "âš ï¸ Push failed"
          fi
