name: Notify on New Internship Roles

permissions:
  contents: write

on:
  schedule:
    - cron: '*/10 * * * *'
  workflow_dispatch:

jobs:
  monitor-internships:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout this repo
        uses: actions/checkout@v3

      - name: Setup Git config
        run: |
          git config user.name "GitHub Action"
          git config user.email "action@github.com"
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}

      # -------------------------------------
      # FETCH README FILES
      # -------------------------------------

      - name: Download SimplifyJobs README
        run: curl -s https://raw.githubusercontent.com/SimplifyJobs/Summer2025-Internships/main/README.md > simplify.md

      - name: Download Vansh/Ouckah README
        run: curl -s https://raw.githubusercontent.com/vanshb03/Summer2026-Internships/main/README.md > ouckah.md

      # -------------------------------------
      # EXTRACT JOB ROWS
      # -------------------------------------

      - name: Extract Simplify SWE Roles
        run: |
          mkdir -p cache
          awk 'BEGIN { flag=0 } 
               /## 💻 Software Engineering Internship Roles/ { flag=1; next } 
               /^## / && flag { flag=0 } 
               flag' simplify.md > cache/_swe_tmp.md || true
          grep -E '^\| ' cache/_swe_tmp.md > cache/latest_simplify_swe.md || true

      - name: Extract All Ouckah Roles
        run: |
          mkdir -p cache
          grep -E '^\| ' ouckah.md > cache/latest_ouckah.md || true

      # -------------------------------------
      # DIFF + NOTIFY — SIMPLIFY
      # -------------------------------------

      - name: Compare Simplify SWE Roles
        id: simplify_diff
        run: |
          cache_file="cache/prev_simplify_swe.md"
          new_file="cache/latest_simplify_swe.md"
          if [ -f "$cache_file" ]; then
            comm -13 <(sort "$cache_file") <(sort "$new_file") > cache/added_simplify.md || true
          else
            cp "$new_file" cache/added_simplify.md
          fi
          if [ -s cache/added_simplify.md ]; then
            echo "new_simplify=true" >> $GITHUB_OUTPUT
          else
            echo "new_simplify=false" >> $GITHUB_OUTPUT
          fi

      - name: Print New Simplify SWE Roles (Debug)
        if: steps.simplify_diff.outputs.new_simplify == 'true'
        run: cat cache/added_simplify.md || echo "None"

      - name: Notify Discord - Simplify SWE
        if: steps.simplify_diff.outputs.new_simplify == 'true'
        run: |
          while IFS= read -r line; do
            # Skip empty or bad rows
            if [ -z "$line" ]; then continue; fi
            pipe_count=$(grep -o '|' <<< "$line" | wc -l)
            if [ "$pipe_count" -lt 4 ]; then echo "⏭️ Bad line: $line"; continue; fi

            company=$(echo "$line" | cut -d '|' -f2 | xargs)
            role=$(echo "$line" | cut -d '|' -f3 | xargs)
            location=$(echo "$line" | cut -d '|' -f4 | xargs)
            link=$(echo "$line" | grep -o 'https[^"]*')

            message="🚨 **New SWE Internship Role (SimplifyJobs)**\n\n**Company**: $company\n**Role**: $role\n**Location**: $location\n**Apply**: $link"
            echo "📨 $company | $role"
            curl -H "Content-Type: application/json" -X POST -d "{\"content\": \"$message\"}" ${{ secrets.DISCORD_WEBHOOK_URL }}
          done < cache/added_simplify.md

      - name: Save Simplify SWE Role State
        run: cp cache/latest_simplify_swe.md cache/prev_simplify_swe.md

      # -------------------------------------
      # DIFF + NOTIFY — OUCKAH
      # -------------------------------------

      - name: Compare Ouckah Roles
        id: ouckah_diff
        run: |
          cache_file="cache/prev_ouckah.md"
          new_file="cache/latest_ouckah.md"
          if [ -f "$cache_file" ]; then
            comm -13 <(sort "$cache_file") <(sort "$new_file") > cache/added_ouckah.md || true
          else
            cp "$new_file" cache/added_ouckah.md
          fi
          if [ -s cache/added_ouckah.md ]; then
            echo "new_ouckah=true" >> $GITHUB_OUTPUT
          else
            echo "new_ouckah=false" >> $GITHUB_OUTPUT
          fi

      - name: Print New Ouckah Roles (Debug)
        if: steps.ouckah_diff.outputs.new_ouckah == 'true'
        run: cat cache/added_ouckah.md || echo "None"

      - name: Notify Discord - Ouckah Roles
        if: steps.ouckah_diff.outputs.new_ouckah == 'true'
        run: |
          while IFS= read -r line; do
            if [ -z "$line" ]; then continue; fi
            pipe_count=$(grep -o '|' <<< "$line" | wc -l)
            if [ "$pipe_count" -lt 4 ]; then echo "⏭️ Bad line: $line"; continue; fi

            company=$(echo "$line" | cut -d '|' -f2 | xargs)
            role=$(echo "$line" | cut -d '|' -f3 | xargs)
            location=$(echo "$line" | cut -d '|' -f4 | xargs)
            link=$(echo "$line" | grep -o 'https[^"]*')

            message="📢 **New Internship Role (Vansh/Ouckah)**\n\n**Company**: $company\n**Role**: $role\n**Location**: $location\n**Apply**: $link"
            echo "📨 $company | $role"
            curl -H "Content-Type: application/json" -X POST -d "{\"content\": \"$message\"}" ${{ secrets.DISCORD_WEBHOOK_URL }}
          done < cache/added_ouckah.md

      - name: Save Ouckah Role State
        run: cp cache/latest_ouckah.md cache/prev_ouckah.md

      # -------------------------------------
      # COMMIT STATE FILES
      # -------------------------------------

      - name: Commit updated role caches
        run: |
          git add cache/prev_*.md
          git commit -m "Update internship role cache" || echo "No changes"
          git push
